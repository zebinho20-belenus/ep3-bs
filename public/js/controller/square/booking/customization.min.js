(function() {
    $(document).ready(function() {
        $("#sb-customization-panel-warning").remove();
        $("#sb-customization-panel").show();

        // Bind events
        $("#sb-quantity").on("change keyup focusout", updateQuantity);
        updateQuantity();

        $(".sb-player-names input").on("change keyup focusout", updatePlayerNames);
        $(".sb-product").on("change", updateProducts);
    });

    function updateQuantity() {
        var quantity = $("#sb-quantity").val();
        var button = $("#sb-button");

        if (button.length) {
            var url = button.attr("href");
            url = url.replace(/q=[0-9]+/, "q=" + quantity);
            button.attr("href", url);
        }

        var playerNames = $(".sb-player-names");
        if (playerNames.length) {
            if (quantity > 1) {
                $(".sb-player-name").hide();
                for (var i = 2; i <= quantity; i++) {
                    $(".sb-player-name-" + i).show();
                }
                playerNames.show();
            } else {
                playerNames.hide();
            }
            $(window).trigger("squarebox.update");
        }
        updatePlayerNames();
    }

    function updatePlayerNames() {
        var button = $("#sb-button");
        if (button.length) {
            var quantity = $("#sb-quantity").val();
            var mode = $(".sb-player-names-mode").data("mode");
            var visibleInputs = $(".sb-player-names input:visible");

            if (quantity > 1) {
                var inputData = visibleInputs.serializeArray();
                var inputJson = JSON.stringify(inputData);
                var param = "pn=" + encodeURIComponent(inputJson);
            } else {
                var param = "pn=0";
            }

            button.css({ opacity: 1 });
            if (mode === "required") {
                visibleInputs.each(function() {
                    if (!$(this).val()) {
                        button.css({ opacity: 0 });
                    }
                });
            }

            var url = button.attr("href");
            url = url.replace(/pn=[^&]+/, param);
            button.attr("href", url);
        }
    }
    function onGuestCheckboxChange() {
        var isChecked = $("#with_guest").is(":checked");
        var sbButton = $("#sb-button");

        if (sbButton.length) {
            var oldHref = sbButton.attr("href");
            var withGuest = isChecked ? "1" : "0";

            // Update the guest parameter (gp) in the URL
            if (oldHref.indexOf("gp=") > -1) {
                // Replace existing parameter
                var newHref = oldHref.replace(/gp=[01]/, "gp=" + withGuest);
                sbButton.attr("href", newHref);
            } else {
                // Add new parameter
                sbButton.attr("href", oldHref + "&gp=" + withGuest);
            }
        }
    }

    $(document).ready(function() {
        // Add event handler for the with_guest checkbox
        $("#with_guest").on("change", onGuestCheckboxChange);

        // Trigger it once on page load to set initial state
        onGuestCheckboxChange();
    });
    function updateProducts() {
        var button = $("#sb-button");
        if (button.length) {
            var products = "";
            $(".sb-product").each(function(index, element) {
                var productId = $(element).data("spid");
                var quantity = $(element).val();
                if (quantity > 0) {
                    products += productId + ":" + quantity + ",";
                }
            });

            if (products) {
                products = products.substr(0, products.length - 1);
            } else {
                products = "0";
            }

            var url = button.attr("href");
            url = url.replace(/p=[0-9\:\,]+/, "p=" + products);
            button.attr("href", url);
        }
    }
})();
